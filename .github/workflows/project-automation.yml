name: Project Column Automation

on:
  issues:
    types: [labeled]
  workflow_call:

jobs:
  sync-label-to-status:
    runs-on: ubuntu-latest
    steps:
      - name: Sync issue label to project status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const STATUS_LABELS = ['Backlog', 'Accepted', 'To do', 'In progress', 'Done', 'Release'];

            const label = context.payload.label?.name;
            if (!label || !STATUS_LABELS.includes(label)) {
              core.info(`Label "${label}" n'est pas un label de statut, ignoré.`);
              return;
            }

            if (context.payload.action === 'unlabeled') {
              core.info(`Label "${label}" retiré, aucune action sur le projet.`);
              return;
            }

            // Récupérer l'issue courante uniquement
            const issue = context.payload.issue;
            const issueNodeId = issue.node_id;
            const owner = 'RaveOnApp';

            // Trouver le projet et le champ Status
            const projectData = await github.graphql(`
              query($owner: String!, $issueId: ID!) {
                organization(login: $owner) {
                  projectsV2(first: 1) {
                    nodes {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id name }
                          }
                        }
                      }
                    }
                  }
                }
                node(id: $issueId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field { ... on ProjectV2SingleSelectField { name } }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { owner, issueId: issueNodeId });

            const projects = projectData.organization.projectsV2.nodes;
            if (!projects.length) {
              core.setFailed('Aucun projet trouvé pour cette organisation.');
              return;
            }
            const project = projects[0];
            core.info(`Projet utilisé : ${project.title} (${project.id})`);

            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            if (!statusField) {
              core.setFailed('Champ "Status" introuvable dans le projet.');
              return;
            }

            // Trouver l'item du projet correspondant à cette issue
            const projectItem = projectData.node.projectItems.nodes.find(
              item => item.project.id === project.id
            );

            if (!projectItem) {
              core.info(`L'issue #${issue.number} n'est pas dans le projet.`);
              return;
            }

            // Vérifier le statut actuel
            const currentStatus = projectItem.fieldValues.nodes.find(
              fv => fv.field?.name === 'Status'
            )?.name;

            if (currentStatus === label) {
              core.info(`Statut déjà à jour : "${label}".`);
              return;
            }

            // Trouver l'option correspondante
            const option = statusField.options.find(o => o.name === label);
            if (!option) {
              core.warning(`Option "${label}" introuvable dans le champ Status.`);
              return;
            }

            // Mettre à jour le statut
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) { projectV2Item { id } }
              }
            `, {
              projectId: project.id,
              itemId: projectItem.id,
              fieldId: statusField.id,
              optionId: option.id,
            });

            core.info(`Issue #${issue.number} : statut mis à jour "${currentStatus}" → "${label}".`);

  set-release-property:
    if: github.event.label.name == 'Pre-release' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Set Release custom field to Status Release description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issue = context.payload.issue;
            const owner = 'RaveOnApp';

            // Retrieve the project, fields, and the item linked to the issue
            const projectData = await github.graphql(`
              query($owner: String!, $issueId: ID!) {
                organization(login: $owner) {
                  projectsV2(first: 1) {
                    nodes {
                      id
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id name description }
                          }
                          ... on ProjectV2Field {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
                node(id: $issueId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                }
              }
            `, { owner, issueId: issue.node_id });

            const project = projectData.organization.projectsV2.nodes[0];
            const projectItem = projectData.node.projectItems.nodes.find(
              item => item.project.id === project.id
            );
            if (!projectItem) {
              core.setFailed("Aucun item de projet lié à cette issue.");
              return;
            }


            // Find the Versioning field
            const versioningField = project.fields.nodes.find(f => f.name === 'Versioning');
            if (!versioningField) {
              core.setFailed('Champ "Versioning" introuvable dans le projet.');
              return;
            }

            // Find the description of the Release status
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const releaseOption = statusField.options.find(o => o.name === 'Pre-release');
            const releaseDescription = releaseOption?.description || '';

            // Update the Versioning field (text)
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { text: $value }
                }) { projectV2Item { id } }
              }
            `, {
              projectId: project.id,
              itemId: projectItem.id,
              fieldId: versioningField.id,
              value: releaseDescription,
            });

            core.info(`Issue #${issue.number} : champ Versioning du projet défini à "${releaseDescription}".`);